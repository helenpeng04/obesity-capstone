---
title: "Does physical inactivity level and access to healthy food affect obesity rate at the county level?"
author: Helen Peng, Anvith Thumma, and Jordan Faustin
format: 
  revealjs:
    theme: simple
    slide-number: true
    smaller: true
editor: visual
---

## Why This Question is Important

-   **Public Health Crisis:** Obesity is a major contributor to chronic diseases (diabetes, heart disease, cancer) and rising healthcare costs.

-   **Disparities in Obesity:** Obesity rates vary widely by region, income, and race/ethnicity. Identifying structural barriers (like food access and inactivity) can inform equitable policies.

-   **Rise in Weight Loss Drugs:** Medications like Ozempic are gaining popularity as quick fixes. But they’re expensive and don’t address root causes like environment or behavior.

## Data Overview

-   Observations: Data at the county level across all 50 U.S. states in 202

-   Variables of Interest:

    -   \% Adults with Obesity

    -   \% Physically Inactive

    -   Food Environment Index (1-10) - Higher is Better

    -   State and County Identifiers

-   Handling Missing Data

    -   If data on Food Environment Index or Physical Inactivity was missing for a county we used the state average.

    -   Seven counties that did not have data for obesity rate, our response variables and so, we had to drop those counties.

```{r setup}
library(knitr)
opts_chunk$set(cache=TRUE, autodep=TRUE, cache.comments=FALSE,
               message=FALSE, warning=FALSE, fig.align="center",
               echo=FALSE, tidy=TRUE)
```

```{r cleaning}
library(readxl)
library(tidyverse)
theme_set(theme_bw())

data_2025 <- read_excel("C:/Users/helen/OneDrive/Documents/GitHub/obesity-capstone/Peng/2025_data.xlsx", sheet = "Additional Measure Data", skip = 1)

food_index_2025 <- read_excel("C:/Users/helen/OneDrive/Documents/GitHub/obesity-capstone/Peng/2025_data.xlsx", sheet = "Select Measure Data", skip = 1)

data_2025 <- data_2025 |> 
  select(FIPS, State, County,
         `Median Household Income`,
         `Days above 90F`,
         `% with access to parks`,
         `% Physically Inactive`,
         `% Adults with Obesity`
  ) |> 
  janitor::clean_names() 

food_index_2025 <- food_index_2025 |> 
  select(FIPS, 
         `% Unemployed`,
         `% Completed High School`,
         `% Some College`,
         `Food Environment Index`
  ) |> 
  janitor::clean_names() 

data_2025 <- merge(data_2025, food_index_2025, by = "fips")
```

```{r missing_data}

old_ct_fips <- c("09001", "09003", "09005", "09007", "09009", "09011", "09013", "09015")  

statewide_food_index <- data_2025 |> 
  filter(is.na(county) & !is.na(food_environment_index)) |> 
  select(state, food_environment_index) |> 
  rename(statewide_food_environment_index = food_environment_index)

data_2025 <- data_2025 |> 
  filter(!(fips %in% old_ct_fips)) |> 
  left_join(statewide_food_index, by = "state") |> 
  mutate(
    food_environment_index = if_else(
      is.na(food_environment_index) & !is.na(county),
      statewide_food_environment_index,
      food_environment_index
    )
  ) |> 
  select(-statewide_food_environment_index) |> 
  filter(!is.na(county)) |> 
  filter(!is.na(percent_adults_with_obesity))
```

## Obesity rates increases as physical inactivity increases and better access to food decreases

```{r scatterplot}
library(patchwork)

physical_obesity_plot <- data_2025 |>
  ggplot(aes(x = percent_physically_inactive, y = percent_adults_with_obesity)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_smooth(method = "gam", se = FALSE, color = "darkred") +
  labs(
    x = "% Physically Inactive",
    y = "% Adults with Obesity"
  ) +
  theme_minimal()

food_obesity_plot <- data_2025 |>
  ggplot(aes(x = food_environment_index, y = percent_adults_with_obesity)) +
  geom_point(alpha = 0.6, color = "darkgreen") +
  geom_smooth(method = "gam", se = FALSE, color = "darkorange") +
  labs(
    x = "Food Environment Index (0 = worst, 10 = best)",
    y = "% Adults with Obesity"
  ) +
  theme_minimal()

food_obesity_plot + physical_obesity_plot 

# cor(data_2025$percent_adults_with_obesity, data_2025$food_environment_index, use = "complete.obs")
# cor(data_2025$percent_adults_with_obesity, data_2025$percent_physically_inactive, use = "complete.obs")
```

## East coast has higher obesity rate than the west coast

```{r obesity_map}
library(tigris)
library(leaflet)
library(sf)

options(tigris_use_cache = TRUE)

counties_sf <- counties(cb = TRUE, resolution = "5m", class = "sf") |>
  mutate(fips = paste0(STATEFP, COUNTYFP))

county_data <- counties_sf |> 
  left_join(data_2025, by = "fips") |>
  filter(!is.na(percent_adults_with_obesity))

county_data <- rmapshaper::ms_simplify(county_data, keep = 0.05)

q_brks <- quantile(county_data$percent_adults_with_obesity, probs = seq(0, 1, length.out = 6), na.rm = TRUE)

pal <- colorBin(
  palette = "YlOrRd",
  bins = q_brks,
  na.color = "transparent"
)

leaflet(county_data) |> 
  addProviderTiles("CartoDB.Positron") |> 
  addPolygons(
    fillColor = ~pal(percent_adults_with_obesity),
    color = "black",
    weight = 0.3,
    fillOpacity = 0.8,
    label = ~paste0(
      NAME, ", ", STATE_NAME, ": ", round(percent_adults_with_obesity, 1), "%"),
    highlightOptions = highlightOptions(
      weight = 1,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) |> 
  addLegend(
    pal = pal,
    values = ~percent_adults_with_obesity,
    title = "Obesity Rate (%)",
    position = "bottomright"
  )
```

## Hierarchical clustering reveals four distinct groups

```{r dendro, include = FALSE}
library(ggdendro)

cluster_data <- data_2025 |>
  select(fips,
         state,
         county,
         percent_adults_with_obesity,
         percent_physically_inactive,
         food_environment_index) |> 
  drop_na()

std_data_features <- cluster_data |> 
  select(percent_adults_with_obesity, percent_physically_inactive, food_environment_index) |> 
  scale()

county_dist <- dist(std_data_features, method = "euclidean")
hc_complete <- hclust(county_dist, method = "complete")

ggdendrogram(hc_complete, labels = FALSE, leaf_labels = FALSE, theme_dendro = FALSE) +    labs(title = "Complete Linkage", y = "Dissimilarity") +
  theme_minimal() +
  theme(
      axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      plot.title = element_text(size = 12, face = "bold"),
      panel.grid = element_blank()
  )
```

```{r cluster_map}
options(tigris_use_cache = TRUE)

data_with_clusters <- cluster_data |> 
  mutate(cluster = as.factor(cutree(hc_complete, k = 4)))

county_clusters <- counties_sf |> 
  left_join(data_with_clusters, by = "fips")

county_clusters <- rmapshaper::ms_simplify(county_clusters, keep = 0.05)

cluster_levels <- levels(data_with_clusters$cluster)
pal <- colorFactor(
  palette = ggthemes::colorblind_pal()(length(cluster_levels)),
  domain = cluster_levels
)

leaflet(county_clusters) |> 
  addProviderTiles("CartoDB.Positron") |> 
  addPolygons(
    fillColor = ~pal(cluster),
    color = "black",
    weight = 0.3,
    fillOpacity = 0.8,
    label = ~paste0(NAME, ", ", STATE_NAME, ": ", 
                    ifelse(is.na(cluster), "No data", paste("Cluster", cluster))),
    highlightOptions = highlightOptions(
      weight = 1,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) |> 
  addLegend(
    pal = pal,
    values = ~cluster,
    title = "Cluster",
    position = "bottomright"
  )
```

## Cluster Profiles

```{r cluster_profiles}
library(knitr)

data_2025 <- data_2025 |> 
  left_join(data_with_clusters |> select(fips, cluster), by = "fips")

# data_2025 |>
#   filter(!is.na(cluster)) |>
#   group_by(cluster) |>
#   summarize(
#     `Cluster` = cluster,
#     `Number of Counties` = n(),
#     `Physically Inactive (%)` = mean(percent_physically_inactive, na.rm = TRUE),
#     `Food Environment Index` = mean(food_environment_index, na.rm = TRUE),
#     `Obesity Rate (%)` = mean(percent_adults_with_obesity, na.rm = TRUE),
#     `Household Income` = mean(median_household_income, na.rm = TRUE),
#     `Days Above 90F` = mean(days_above_90f, na.rm = TRUE),
#     `Access To Parks (%)` = mean(percent_with_access_to_parks, na.rm = TRUE),
#     `Unemployment Rate (%)` = mean(percent_unemployed, na.rm = TRUE),
#     `Completed High School (%)` = mean(percent_completed_high_school, na.rm = TRUE),
#     `Completed Some College (%)` = mean(percent_some_college, na.rm = TRUE)
#   ) |>
#   kable(digits = 2)

data_2025_long <- data_2025 |> 
  filter(!is.na(cluster)) |> 
  pivot_longer(
    cols = -c(fips, state, county, cluster),
    names_to = "variable", 
    values_to = "value"
  ) |> 
  mutate(
    variable = recode(variable,
      median_household_income = "Median Household Income",
      days_above_90f = "Days Above 90F",
      percent_adults_with_obesity = "Adults with Obesity (%)",
      percent_with_access_to_parks = "Access To Parks (%)",
      percent_physically_inactive = "Physically Inactive (%)",
      percent_unemployed = "Unemployment Rate (%)",
      percent_completed_high_school = "Completed High School (%)",
      percent_some_college = "Completed Some College (%)",
      food_environment_index = "Food Environment Index"
    ),
    variable = factor(variable, levels = c(
      "Adults with Obesity (%)",
      "Food Environment Index",
      "Physically Inactive (%)",
      "Access To Parks (%)",
      "Completed High School (%)",
      "Completed Some College (%)",
      "Unemployment Rate (%)",
      "Median Household Income",
      "Days Above 90F"
    ))
  )

data_2025_long |> 
  ggplot(aes(x = factor(cluster), y = value, fill = factor(cluster))) +
  geom_boxplot() +
  labs(
    x = "Cluster",
    y = "Value"
  ) +
  facet_wrap(~variable, scales = "free_y") +
  ggthemes::scale_fill_colorblind() +    
  theme_bw(base_size = 8) +
  theme(
    strip.background = element_blank(),     
    legend.position = "none"                    
  )
```

**Cluster 1 –** Moderately inactive, decent food access, high obesity

**Cluster 2 –** Very inactive, moderate food access, highest obesity

**Cluster 3 –** Very inactive, worst food access, high obesity

**Cluster 4 –** Most active, best food access, lowest obesity – Best Case

## Recommendations Based On Clusters

improve access to parks in cluster 1+2

in cluster 3 there are numerous days that are extremely hot so adding parks won't do much, instead we could build gyms

## Plan of Action

Completed:

-   Created a map to visualize geographic patterns in obesity rates

-   Generated scatter plots to explore relationships between obesity, food access, and physical inactivity

-   Performed clustering analysis and compared profiles across clusters

Next Steps:

-   Conduct beta regression and decision tree analysis to model obesity-related outcomes
-   Continue drafting the final report and designing the project poster

```{r include = FALSE}
library(betareg)

data_2025 <- data_2025 |> 
  mutate(
    obesity_prop = percent_adults_with_obesity / 100
    # inactivity_prop = percent_physically_inactive /100 do i also need to do this
  )

beta_model <- betareg(obesity_prop ~ food_environment_index + percent_physically_inactive, data = data_2025)
summary(beta_model)

# colSums(is.na(data_2025))

data_2025$predicted_obesity <- predict(beta_model, type = "response")

ggplot(data_2025, aes(x = obesity_prop, y = predicted_obesity)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(
    x = "Observed Obesity Proportion",
    y = "Predicted Obesity Proportion",
    title = "Actual vs Predicted Obesity Proportions"
  ) +
  theme_minimal()

# i guess make MSE??? idk beta regression confuses me yo
```
